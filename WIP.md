Work in progress
----------------


- Get heroku working
  - build assets on deploy? rake asset:precompile override?

---

Needs rails_12factor gem:

gem "rails_12factor", group: :production

---

`bin/ember` and/or `bin/phonegap` scripts? Useful or not enough of a case given Foreman processes?

---

Automate zip create and/or upload and/or download with bash script or rake task?

---

Improve performance of `ember build --watch`? Could not find watchman, falling back to NodeWatcher for file system events. Visit http://www.ember-cli.com/#watchman for more info.

---

Use `bundle exec` vs `bin/rails` vs `rails` on Windows? Generate binstubs on Windows?

---

- Use LiveReload with PhoneGap developer app and with Rails server. Use Ember's LiveReload for both and pass `--no-autoreload` option to `phonegap serve`?

- Is `phonegap serve` needed? Can `rails server` do the same job?

---

# Preparing for Production


## Multiple index pages and rewrite rules

Configure `index.html` to be named `index.rails.html`. For now, we will differentiate between the two HTML root files -- the one generated by PhoneGap, and the one generated by Ember that will be served by our Rails app. Ember's compilation configuration for this is specified in `client/Brocfile.js`, replace the existing `var app = new EmberApp();` line with this:

```javascript
var app = new EmberApp({
  outputPaths: {
    app: {
      html: 'index.rails.html'
    }
  }
});
```

We now need to tell Rails to serve `index.rails.html` instead of `index.html`. We'll do this with the help of the [rack-rewrite](https://github.com/jtrupiano/rack-rewrite) gem, which among other things lets us rewrite URLs on the server without changing the URLs our users see. (In case you're familiar with the Apache web server's rewrite module (mod_rewrite), then you'll find rack-rewrite can perform similar tasks).

rack-rewrite is going to make it so requests for `index.html` are re-routed to `index.rails.html`.

Add the rack-rewrite gem to the `Gemfile`:

```ruby
gem 'rack-rewrite'
```

Run `bundle install` in the Terminal.

Create an initializer at `my-rails-app/config/initializers/rewrite_rules.rb` with this content:

```ruby
Rails.application.config.middleware.insert_before(ActionDispatch::Static, Rack::Rewrite) do
  # Requests for "/" or "/index.html" will respond with "/index.rails.html". This won't
  # be visible in the browser's address bar, users will never know about it.
  rewrite %r{\A/(index\.html)?\z}, '/index.rails.html'
end
```

## Configuring PhoneGap's Index Page

In PhoneGap's `client/wrap/config.xml`, change the `content` element's `src` attribute to be `index.phonegap.html`:

```xml
<content src="index.phonegap.html" />
```

The above change to `config.xml` tells PhoneGap to use `index.phonegap.html` as its default page, instead of `index.html`. At the time of writing, there appears to be a bug in `phonegap serve` that means it ignores this setting, it still expects `index.html`. Workaround this bug for now with a symlink:

```bash
TODO: put symlink instructions here for index.html -> index.phonegap.html
```

## Heroku Deployment

For now, for our Heroku production deployment, we are going to generate the production assets on our own computer and store them in our git repository. This is different to what normally happens with Rails apps, where Heroku generates the production assets as part of the deployment process and the generated asset files are *not* stored in the repo (we'll revisit this in a later chapter).

### Dedicated Environment `dist/` Directories

The assets Ember creates for the development and production environments are different. The production assets take a little longer to build and they have performance optimizations applied to them that get in the way when you want to debug during development.

Ember's default configuration has the assets generated in the `dist/` directory regardless of what environment you're building for. Let's alter this default so we have a dedicated subdirectory in `dist/` for each environment:

- `dist/development` for the generated **development** assets. These will *not* be stored in the git repo.
- `dist/production` for the generated **production** assets. These *will be* stored in the git repo because the production assets need to be in the repo that is pushed to Heroku at deploy time.


---

Not ideal using hash location type in non-PhoneGap web app, URLs have visible hashes. Experiment with something like this in environment.js:

```javascript
  locationType: location.protocol === "file:" ? 'hash' : 'auto',
```
