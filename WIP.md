Work in progress
----------------

Special instructions:

- Create `bin/phonegap` script as detailed here in `bin/phonegap` section (TODO: add link).

- Create `bin/ember` script as detailed here in `bin/ember` section (TODO: add link).

- Edit `Procfile(.development)` so its contents are as follows:

```
rails: bin/rails server --port 3000
ember: bin/ember build --watch
phonegap: bin/phonegap serve --port 4000
```

- As `ember init` didn't run with `--skip-npm --skip-bower`, the `node_modules` and `bower_components`directories need to be moved to the project root. The client directory will then have symlinks to these directories. These directories hold the dependencies for node and for bower. By moving them to the project root, these dependencies are in a more universal, more accessible, and more easily deployed location for development and production environments. Perform these changes:

```bash
# Inside my-rails-app/ dir
mv client/node_modules ./node_modules
mv client/bower_components ./bower_components

# Symlink to dependency folders, enables ember commands to continue to operate
# without error:
ln -s ../bower_components client/bower_components
ln -s ../node_modules client/node_modules

# Move package.json to project root, and symlink from old location in client/:
# (package.json expected in project root by Heroku)
mv client/package.json ./
ln -s ../package.json client/package.json

# Move bower.json and .bowerrc to project root:
mv client/bower.json ./
mv client/.bowerrc ./

# Symlink bower.json and .bowerrc from client/ so ember operates without error:
ln -s ../bower.json client/bower.json
ln -s ../.bowerrc client/.bowerrc

# Install bower under devDependencies in package.json with this
# (deployment to production will require this in package.json):
npm install --save-dev bower
```

Remove these lines from `client/.gitignore` **and** add them to `.gitignore`:
```
# Ignore local npm dependencies as they are derived from package.json
/node_modules

# Ignore local bower dependencies as they are derived from bower.json
/bower_components
```

Commit all the above changes to version control.

---

PhoneGap Build: Automate zip create and/or upload and/or download with bash script or rake task?

---

Improve performance of `ember build --watch`? Could not find watchman, falling back to NodeWatcher for file system events. Visit http://www.ember-cli.com/#watchman for more info.

---

- Use LiveReload with PhoneGap developer app and with Rails server. Use Ember's LiveReload for both and pass `--no-autoreload` option to `phonegap serve`?

---

- Is `phonegap serve` needed? Can `rails server` do the same job?

---

# Preparing for Production

## Multiple index pages and rewrite rules

Configure `index.html` to be named `index.rails.html`. For now, we will differentiate between the two HTML root files -- the one generated by PhoneGap, and the one generated by Ember that will be served by our Rails app. Ember's compilation configuration for this is specified in `client/Brocfile.js`, replace the existing `var app = new EmberApp();` line with this:

```javascript
var app = new EmberApp({
  outputPaths: {
    app: {
      html: 'index.rails.html'
    }
  }
});
```

We now need to tell Rails to serve `index.rails.html` instead of `index.html`. We'll do this with the help of the [rack-rewrite](https://github.com/jtrupiano/rack-rewrite) gem, which among other things lets us rewrite URLs on the server without changing the URLs our users see. (In case you're familiar with the Apache web server's rewrite module (mod_rewrite), then you'll find rack-rewrite can perform similar tasks).

rack-rewrite is going to make it so requests for `index.html` are re-routed to `index.rails.html`.

Add the rack-rewrite gem to the `Gemfile`:

```ruby
gem 'rack-rewrite'
```

Run `bundle install` in the Terminal.

Create an initializer at `my-rails-app/config/initializers/rewrite_rules.rb` with this content:

```ruby
Rails.application.config.middleware.insert_before(ActionDispatch::Static, Rack::Rewrite) do
  # Requests for "/" or "/index.html" will respond with "/index.rails.html". This won't
  # be visible in the browser's address bar, users will never know about it.
  rewrite %r{\A/(index\.html)?\z}, '/index.rails.html'
end
```

## Configuring PhoneGap's Index Page

In PhoneGap's `client/wrap/config.xml`, change the `content` element's `src` attribute to be `index.phonegap.html`:

```xml
<content src="index.phonegap.html" />
```

The above change to `config.xml` tells PhoneGap to use `index.phonegap.html` as its default page, instead of `index.html`. At the time of writing, there appears to be a bug in `phonegap serve` that means it ignores this setting, it still expects `index.html`. Workaround this bug for now with a symlink:

```bash
TODO: put symlink instructions here for index.html -> index.phonegap.html
```
---

Not ideal using hash location type in non-PhoneGap web app, URLs have visible hashes. Experiment with something like this in environment.js:

```javascript
  locationType: location.protocol === "file:" ? 'hash' : 'auto',
```
---

Use a .slugignore with Heroku to ignore files (e.g. development settings like `.foreman`):

> The .slugignore file causes files to be removed after you push code to Heroku and before the buildpack runs. This lets you prevent large files from being included in the final slug

Source: https://devcenter.heroku.com/articles/slug-compiler#ignoring-files-with-slugignore

---
